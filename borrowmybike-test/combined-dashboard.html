<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>BorrowMyBike ‚Äî Combined Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase UMD (global window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 1150px; margin: 24px auto; padding: 0 12px; }
    h1 { margin: 0 0 10px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 12px 0; }
    label { display:block; margin: 8px 0 4px; font-weight: 700; }
    input, button { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; font-weight: 800; }
    .btn { background: #111; color: #fff; border: 1px solid #111; }
    .btn-secondary { background: #fff; color: #111; border: 1px solid #111; }
    .btn-danger { background: #b00020; color: #fff; border: 1px solid #b00020; }
    .btn-disabled { opacity: 0.45; cursor: not-allowed; }
    .small { font-size: 12px; color: #555; }
    .ok { color: #0a7a0a; font-weight: 800; }
    .bad { color: #b00020; font-weight: 800; }
    code { background:#f2f2f2; padding: 2px 6px; border-radius: 6px; }

    .tabs { display: flex; gap: 8px; margin-top: 8px; }
    .tab { padding: 10px 12px; border-radius: 999px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-weight: 800; }
    .tab.active { background: #111; color: #fff; border-color: #111; }
    .hidden { display: none; }

    table { border-collapse: collapse; width: 100%; margin-top: 8px; }
    th, td { border: 1px solid #eee; padding: 8px; vertical-align: top; font-size: 13px; }
    th { background: #fafafa; text-align: left; }
    .tag { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #f2f2f2; font-size: 12px; margin: 2px 0; }
    pre { background:#f7f7f7; padding: 12px; border-radius: 12px; overflow:auto; max-height: 320px; }

    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <h1>BorrowMyBike ‚Äî Combined Dashboard</h1>
  <div class="small">
    This dashboard logs in with Supabase Auth and uses your JWT to call Edge Functions.
    No pasted UUIDs. No anon-key impersonation.
  </div>

  <!-- CONFIG + AUTH -->
  <div class="card">
    <h2 style="margin:0 0 8px;">1) Config + Login</h2>

    <div class="row">
      <div>
        <label>SUPABASE_URL</label>
        <input id="sbUrl" value="https://yvgwdqeiygzfdhjthilw.supabase.co" />
      </div>
      <div>
        <label>SUPABASE_ANON_KEY</label>
        <input id="sbAnon" placeholder="Paste anon public key (Project Settings ‚Üí API)" />
        <div class="small">Do not paste service_role here.</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" placeholder="email" />
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" placeholder="password" />
      </div>
    </div>

    <div class="row">
      <button id="initBtn" class="btn-secondary">Initialize</button>
      <button id="loginBtn" class="btn btn-disabled" disabled>Login</button>
    </div>

    <div class="row">
      <button id="logoutBtn" class="btn-danger btn-disabled" disabled>Logout</button>
      <button id="refreshBtn" class="btn btn-disabled" disabled>Refresh Bookings</button>
    </div>

    <div id="authStatus" class="small"></div>
    <div id="status" class="small" style="margin-top:6px;"></div>
  </div>

  <!-- TABS -->
  <div class="card hidden" id="dashCard">
    <h2 style="margin:0 0 8px;">2) Dashboard</h2>

    <div class="small">
      Logged in as: <code id="uidBox"></code>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabBorrowing">Borrowing</div>
      <div class="tab" id="tabLending">Lending</div>
    </div>

    <!-- BORROWING -->
    <div id="panelBorrowing" style="margin-top: 10px;">
      <div class="small">Your bookings as a borrower.</div>
      <div id="borrowerTableWrap" style="margin-top: 10px;"></div>

      <h3 style="margin:16px 0 6px;">Raw JSON (Borrowing)</h3>
      <pre id="borrowerRaw">{}</pre>
    </div>

    <!-- LENDING -->
    <div id="panelLending" class="hidden" style="margin-top: 10px;">
      <div class="small">Your bookings as an owner.</div>
      <div id="ownerTableWrap" style="margin-top: 10px;"></div>

      <h3 style="margin:16px 0 6px;">Raw JSON (Lending)</h3>
      <pre id="ownerRaw">{}</pre>
    </div>
  </div>

<script>
  let sb = null;
  let session = null;

  function $(id) { return document.getElementById(id); }
  function setStatus(msg, ok=null) {
    if (ok === true) $("status").innerHTML = `<span class="ok">${escapeHtml(msg)}</span>`;
    else if (ok === false) $("status").innerHTML = `<span class="bad">${escapeHtml(msg)}</span>`;
    else $("status").textContent = msg;
  }
  function setAuthStatus(msg, ok=null) {
    if (ok === true) $("authStatus").innerHTML = `<span class="ok">${escapeHtml(msg)}</span>`;
    else if (ok === false) $("authStatus").innerHTML = `<span class="bad">${escapeHtml(msg)}</span>`;
    else $("authStatus").textContent = msg;
  }
  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function yesNo(v) { return v ? `<span class="tag">yes</span>` : `<span class="tag">no</span>`; }
  function text(v) { return escapeHtml(v ?? ""); }

  function cfg() {
    const SUPABASE_URL = $("sbUrl").value.trim();
    const SUPABASE_ANON_KEY = $("sbAnon").value.trim();
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) throw new Error("Missing Supabase URL or anon key.");
    return { SUPABASE_URL, SUPABASE_ANON_KEY };
  }
  function authzHeaders() {
    if (!session?.access_token) throw new Error("Not logged in.");
    return { "Authorization": `Bearer ${session.access_token}` };
  }
  async function safeJson(res) {
    const text = await res.text();
    try { return { ok: true, json: JSON.parse(text), text }; }
    catch { return { ok: false, json: null, text }; }
  }

  // ---- Tab logic
  function setTab(which) {
    const borrowing = which === "borrowing";
    $("tabBorrowing").classList.toggle("active", borrowing);
    $("tabLending").classList.toggle("active", !borrowing);
    $("panelBorrowing").classList.toggle("hidden", !borrowing);
    $("panelLending").classList.toggle("hidden", borrowing);
  }
  $("tabBorrowing").addEventListener("click", () => setTab("borrowing"));
  $("tabLending").addEventListener("click", () => setTab("lending"));

  // ---- Booking action eligibility (same logic you had, centralized)
  function canBorrowerCheckIn(b) {
    return !!b.borrower_paid && !!b.owner_deposit_paid && !b.borrower_checked_in && !b.cancelled && !b.completed;
  }
  function canOwnerCheckIn(b) {
    return !!b.borrower_paid && !!b.owner_deposit_paid && !b.owner_checked_in && !b.cancelled && !b.completed;
  }

  function canBorrowerConfirmComplete(b) {
    // Your backend enforces timing; UI keeps it simple:
    return !!b.borrower_checked_in && !!b.owner_checked_in && !b.borrower_confirmed_complete && !b.cancelled && !b.settled;
  }
  function canOwnerConfirmComplete(b) {
    return !!b.borrower_checked_in && !!b.owner_checked_in && !b.owner_confirmed_complete && !b.cancelled && !b.settled;
  }

  function canPayDeposit(b) {
    return !!b.borrower_paid && !b.owner_deposit_paid && !b.cancelled && !b.completed;
  }

  function isSettleEligible(b) {
    // Keep this conservative; backend will also enforce.
    const ready = (!!b.borrower_paid && !!b.owner_deposit_paid) || b.treat_as_owner_no_show || b.treat_as_borrower_no_show || b.bike_invalid;
    return ready && !b.cancelled && !b.settled;
  }

  function canReportOwnerNoShow(b) {
    // Borrower can report owner no-show via settle-booking action (backend checks timing)
    return !!b.borrower_checked_in && !b.owner_checked_in && !b.cancelled && !b.settled;
  }
  function canReportBorrowerNoShow(b) {
    // Owner can report borrower no-show via settle-booking action (backend checks timing)
    return !!b.owner_checked_in && !b.borrower_checked_in && !b.cancelled && !b.settled;
  }

  // ---- Rendering
  function renderBorrowerTable(bookings) {
    if (!bookings || !bookings.length) {
      $("borrowerTableWrap").innerHTML = "No borrower bookings returned.";
      return;
    }

    const rows = bookings.map(b => {
      const checkInBtn = canBorrowerCheckIn(b)
        ? `<button class="btn" onclick="checkIn('${b.id}','borrower')">I‚Äôm here (Borrower check-in)</button>`
        : `<button class="btn btn-disabled" disabled>Checked in</button>`;

      const confirmBtn = canBorrowerConfirmComplete(b)
        ? `<button class="btn" onclick="confirmComplete('${b.id}','borrower')">Borrower confirms complete ‚úÖ</button>`
        : `<button class="btn btn-disabled" disabled>Borrower confirm</button>`;

      const ownerNoShowBtn = canReportOwnerNoShow(b)
        ? `<button class="btn-danger" onclick="reportOwnerNoShow('${b.id}')">Report owner no-show ‚ùå</button>`
        : `<button class="btn btn-disabled" disabled>Report owner no-show</button>`;

      const settleBtn = isSettleEligible(b)
        ? `<button class="btn-secondary" onclick="settleBooking('${b.id}')">Settle booking üí∞</button>`
        : `<button class="btn btn-disabled" disabled>Settle</button>`;

      const settledTag = b.settled
        ? `<span class="tag">settled ‚úÖ (${text(b.settlement_outcome)})</span><br/><span class="tag">${text(b.settled_at)}</span>`
        : `<span class="tag">not settled</span>`;

      return `
        <tr>
          <td>${text(b.id)}</td>
          <td>${text(b.booking_date || b.scheduled_start_at)}</td>
          <td>${yesNo(b.borrower_paid)}</td>
          <td>${yesNo(b.owner_deposit_paid)}</td>
          <td>${yesNo(b.borrower_checked_in)} / ${yesNo(b.owner_checked_in)}</td>
          <td>${yesNo(b.borrower_confirmed_complete)} / ${yesNo(b.owner_confirmed_complete)}</td>
          <td>${settledTag}</td>
          <td style="min-width:260px;">
            ${checkInBtn}<br/>
            ${confirmBtn}<br/>
            ${ownerNoShowBtn}<br/>
            ${settleBtn}
          </td>
        </tr>
      `;
    }).join("");

    $("borrowerTableWrap").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>booking_id</th>
            <th>date</th>
            <th>borrower_paid</th>
            <th>owner_deposit_paid</th>
            <th>check-ins (B/O)</th>
            <th>confirm complete (B/O)</th>
            <th>settlement</th>
            <th>actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  function renderOwnerTable(bookings) {
    if (!bookings || !bookings.length) {
      $("ownerTableWrap").innerHTML = "No owner bookings returned.";
      return;
    }

    const rows = bookings.map(b => {
      const payBtn = canPayDeposit(b)
        ? `<button class="btn" onclick="payDeposit('${b.id}')">Pay deposit ($150)</button>`
        : `<button class="btn btn-disabled" disabled>Pay deposit</button>`;

      const checkInBtn = canOwnerCheckIn(b)
        ? `<button class="btn" onclick="checkIn('${b.id}','owner')">I‚Äôm here (Owner check-in)</button>`
        : `<button class="btn btn-disabled" disabled>Checked in</button>`;

      const confirmBtn = canOwnerConfirmComplete(b)
        ? `<button class="btn" onclick="confirmComplete('${b.id}','owner')">Owner confirms complete ‚úÖ</button>`
        : `<button class="btn btn-disabled" disabled>Owner confirm</button>`;

      const borrowerNoShowBtn = canReportBorrowerNoShow(b)
        ? `<button class="btn-danger" onclick="reportBorrowerNoShow('${b.id}')">Report borrower no-show ‚ùå</button>`
        : `<button class="btn btn-disabled" disabled>Report borrower no-show</button>`;

      const settleBtn = isSettleEligible(b)
        ? `<button class="btn-secondary" onclick="settleBooking('${b.id}')">Settle booking üí∞</button>`
        : `<button class="btn btn-disabled" disabled>Settle</button>`;

      const settledTag = b.settled
        ? `<span class="tag">settled ‚úÖ (${text(b.settlement_outcome)})</span><br/><span class="tag">${text(b.settled_at)}</span>`
        : `<span class="tag">not settled</span>`;

      return `
        <tr>
          <td>${text(b.id)}</td>
          <td>${text(b.booking_date || b.scheduled_start_at)}</td>
          <td>${yesNo(b.borrower_paid)}</td>
          <td>${yesNo(b.owner_deposit_paid)}</td>
          <td>${yesNo(b.borrower_checked_in)} / ${yesNo(b.owner_checked_in)}</td>
          <td>${yesNo(b.borrower_confirmed_complete)} / ${yesNo(b.owner_confirmed_complete)}</td>
          <td>${settledTag}</td>
          <td style="min-width:260px;">
            ${payBtn}<br/>
            ${checkInBtn}<br/>
            ${confirmBtn}<br/>
            ${borrowerNoShowBtn}<br/>
            ${settleBtn}
          </td>
        </tr>
      `;
    }).join("");

    $("ownerTableWrap").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>booking_id</th>
            <th>date</th>
            <th>borrower_paid</th>
            <th>owner_deposit_paid</th>
            <th>check-ins (B/O)</th>
            <th>confirm complete (B/O)</th>
            <th>settlement</th>
            <th>actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // ---- Data loading
  async function loadBorrowerBookings() {
    const { SUPABASE_URL } = cfg();
    const uid = session.user.id;

    setStatus("Loading borrower bookings...");
    const url = `${SUPABASE_URL}/functions/v1/get-borrower-bookings?borrower_id=${encodeURIComponent(uid)}`;

    const res = await fetch(url, { method: "GET", headers: { ...authzHeaders() } });
    const parsed = await safeJson(res);

    if (!parsed.ok) {
      $("borrowerRaw").textContent = JSON.stringify({ http_status: res.status, raw_text: parsed.text }, null, 2);
      setStatus("Borrower bookings: could not parse JSON (see raw).", false);
      return;
    }

    $("borrowerRaw").textContent = JSON.stringify({ http_status: res.status, ok: res.ok, response: parsed.json }, null, 2);
    renderBorrowerTable(parsed.json.bookings || []);
    setStatus("Borrower bookings loaded ‚úÖ", true);
  }

  async function loadOwnerBookings() {
    const { SUPABASE_URL } = cfg();
    const uid = session.user.id;

    setStatus("Loading owner bookings...");
    const url = `${SUPABASE_URL}/functions/v1/get-owner-bookings?owner_id=${encodeURIComponent(uid)}`;

    const res = await fetch(url, { method: "GET", headers: { ...authzHeaders() } });
    const parsed = await safeJson(res);

    if (!parsed.ok) {
      $("ownerRaw").textContent = JSON.stringify({ http_status: res.status, raw_text: parsed.text }, null, 2);
      setStatus("Owner bookings: could not parse JSON (see raw).", false);
      return;
    }

    $("ownerRaw").textContent = JSON.stringify({ http_status: res.status, ok: res.ok, response: parsed.json }, null, 2);
    renderOwnerTable(parsed.json.bookings || []);
    setStatus("Owner bookings loaded ‚úÖ", true);
  }

  async function refreshAll() {
    await loadBorrowerBookings();
    await loadOwnerBookings();
  }

  // ---- Actions (Edge Functions)
  window.payDeposit = async (booking_id) => {
    try {
      const { SUPABASE_URL } = cfg();
      if (!confirm("Pay owner deposit ($150) via Stripe Checkout?")) return;
      setStatus(`Creating owner deposit checkout... booking_id=${booking_id}`);

      const res = await fetch(`${SUPABASE_URL}/functions/v1/create-owner-deposit-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authzHeaders() },
        body: JSON.stringify({ booking_id })
      });

      const parsed = await safeJson(res);
      if (!parsed.ok || !parsed.json) throw new Error("Could not parse response JSON.");

      // Expect checkout_url
      if (parsed.json.checkout_url) {
        setStatus("Redirecting to Stripe Checkout‚Ä¶", true);
        window.location.href = parsed.json.checkout_url;
        return;
      }

      // Fallback
      alert("No checkout_url returned. See Raw JSON in Lending tab.");
      $("ownerRaw").textContent = JSON.stringify({ http_status: res.status, ok: res.ok, response: parsed.json }, null, 2);
      setStatus("Deposit call did not return checkout_url.", false);
    } catch (e) {
      console.error(e);
      setStatus(`Deposit failed: ${e.message}`, false);
    }
  };

  window.checkIn = async (booking_id, who) => {
    try {
      const { SUPABASE_URL } = cfg();
      setStatus(`Checking in (${who})... booking_id=${booking_id}`);

      const res = await fetch(`${SUPABASE_URL}/functions/v1/check-in`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authzHeaders() },
        body: JSON.stringify({ booking_id, who })
      });

      const parsed = await safeJson(res);
      if (!parsed.ok) throw new Error("Could not parse response JSON.");

      if (!res.ok) {
        alert(`Check-in failed: ${parsed.json?.error || parsed.text}`);
        setStatus("Check-in failed (see console/raw).", false);
      } else {
        setStatus("Check-in saved ‚úÖ", true);
      }

      await refreshAll();
    } catch (e) {
      console.error(e);
      setStatus(`Check-in error: ${e.message}`, false);
    }
  };

  window.confirmComplete = async (booking_id, who) => {
    try {
      const { SUPABASE_URL } = cfg();
      if (!confirm(`Confirm complete as ${who}?`)) return;

      setStatus(`Confirming completion (${who})... booking_id=${booking_id}`);

      const res = await fetch(`${SUPABASE_URL}/functions/v1/complete-booking`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authzHeaders() },
        body: JSON.stringify({ booking_id, who })
      });

      const parsed = await safeJson(res);
      if (!parsed.ok) throw new Error("Could not parse response JSON.");

      if (!res.ok) {
        alert(`Complete failed: ${parsed.json?.error || parsed.text}`);
        setStatus("Complete failed (see console/raw).", false);
      } else {
        setStatus("Complete saved ‚úÖ", true);
      }

      await refreshAll();
    } catch (e) {
      console.error(e);
      setStatus(`Complete error: ${e.message}`, false);
    }
  };

  window.reportOwnerNoShow = async (booking_id) => {
    try {
      const { SUPABASE_URL } = cfg();
      if (!confirm("Report owner no-show? Backend enforces grace rules.")) return;

      setStatus(`Reporting owner no-show... booking_id=${booking_id}`);

      const res = await fetch(`${SUPABASE_URL}/functions/v1/settle-booking`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authzHeaders() },
        body: JSON.stringify({ booking_id, action: "report_owner_no_show" })
      });

      const parsed = await safeJson(res);
      if (!parsed.ok) throw new Error("Could not parse response JSON.");

      if (!res.ok) {
        alert(`Report failed: ${parsed.json?.error || parsed.text}`);
        setStatus("Report failed.", false);
      } else {
        setStatus("Reported ‚úÖ", true);
      }

      await refreshAll();
    } catch (e) {
      console.error(e);
      setStatus(`Report error: ${e.message}`, false);
    }
  };

  window.reportBorrowerNoShow = async (booking_id) => {
    try {
      const { SUPABASE_URL } = cfg();
      if (!confirm("Report borrower no-show? Backend enforces grace rules.")) return;

      setStatus(`Reporting borrower no-show... booking_id=${booking_id}`);

      const res = await fetch(`${SUPABASE_URL}/functions/v1/settle-booking`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authzHeaders() },
        body: JSON.stringify({ booking_id, action: "report_borrower_no_show" })
      });

      const parsed = await safeJson(res);
      if (!parsed.ok) throw new Error("Could not parse response JSON.");

      if (!res.ok) {
        alert(`Report failed: ${parsed.json?.error || parsed.text}`);
        setStatus("Report failed.", false);
      } else {
        setStatus("Reported ‚úÖ", true);
      }

      await refreshAll();
    } catch (e) {
      console.error(e);
      setStatus(`Report error: ${e.message}`, false);
    }
  };

  window.settleBooking = async (booking_id) => {
    try {
      const { SUPABASE_URL } = cfg();
      if (!confirm("Attempt settlement now? (Backend decides eligibility)")) return;

      setStatus(`Settling... booking_id=${booking_id}`);

      const res = await fetch(`${SUPABASE_URL}/functions/v1/settle-booking`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authzHeaders() },
        body: JSON.stringify({ booking_id, action: "settle" })
      });

      const parsed = await safeJson(res);
      if (!parsed.ok) throw new Error("Could not parse response JSON.");

      if (!res.ok) {
        alert(`Settle failed: ${parsed.json?.error || parsed.text}`);
        setStatus("Settlement failed.", false);
      } else {
        setStatus("Settlement attempted ‚úÖ", true);
      }

      await refreshAll();
    } catch (e) {
      console.error(e);
      setStatus(`Settlement error: ${e.message}`, false);
    }
  };

  // ---- Init / Login / Logout
  $("initBtn").addEventListener("click", () => {
    try {
      const { SUPABASE_URL, SUPABASE_ANON_KEY } = cfg();
      if (!window.supabase?.createClient) throw new Error("Supabase library missing.");
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      setAuthStatus("Initialized. You can login now.", true);
      $("loginBtn").disabled = false;
      $("loginBtn").classList.remove("btn-disabled");
    } catch (e) {
      setAuthStatus(e.message, false);
      console.error(e);
    }
  });

  $("loginBtn").addEventListener("click", async () => {
    try {
      if (!sb) throw new Error("Initialize first.");
      const email = $("email").value.trim();
      const password = $("password").value;
      if (!email || !password) throw new Error("Enter email + password.");

      setAuthStatus("Logging in...");
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) throw error;

      session = data.session;
      $("uidBox").textContent = session.user.id;

      $("logoutBtn").disabled = false;
      $("logoutBtn").classList.remove("btn-disabled");

      $("refreshBtn").disabled = false;
      $("refreshBtn").classList.remove("btn-disabled");

      $("dashCard").classList.remove("hidden");

      setAuthStatus(`Logged in ‚úÖ`, true);
      await refreshAll();
    } catch (e) {
      setAuthStatus(`Login failed: ${e.message}`, false);
      console.error(e);
    }
  });

  $("logoutBtn").addEventListener("click", async () => {
    try {
      if (!sb) return;
      await sb.auth.signOut();
      session = null;
      setAuthStatus("Logged out.");
      $("dashCard").classList.add("hidden");
      $("logoutBtn").disabled = true;
      $("logoutBtn").classList.add("btn-disabled");
      $("refreshBtn").disabled = true;
      $("refreshBtn").classList.add("btn-disabled");
      $("borrowerRaw").textContent = "{}";
      $("ownerRaw").textContent = "{}";
      $("borrowerTableWrap").innerHTML = "";
      $("ownerTableWrap").innerHTML = "";
    } catch (e) {
      console.error(e);
    }
  });

  $("refreshBtn").addEventListener("click", async () => {
    try {
      await refreshAll();
    } catch (e) {
      console.error(e);
      setStatus(`Refresh error: ${e.message}`, false);
    }
  });
</script>

</body>
</html>
